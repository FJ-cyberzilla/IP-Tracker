name: C/C++ CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04 

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Install System Dependencies & Compile GTest üõ†Ô∏è
      run: |
        sudo apt-get update
        # Install necessary tools: build-essential, cmake, libcurl (for cpr), and gtest source
        sudo apt-get install -y build-essential cmake libcurl4-openssl-dev libgtest-dev

        echo "Compiling and installing GTest libraries to system path..."
        
        # 1. Compile GTest from source (required because libgtest-dev only installs source files)
        cd /usr/src/googletest
        # Create a build directory for GTest compilation
        sudo mkdir -p build
        cd build
        # Configure GTest
        sudo cmake ..
        # Compile GTest binaries
        sudo make
        
        # 2. Copy compiled libraries to a path where CMake's FindGTest module can discover them
        # Note: We use the system's standard library path.
        sudo cp lib/libgtest*.a /usr/lib/x86_64-linux-gnu/
        
        # Return to the root of your project repository
        cd - 

    # --- Configuration (This step will now succeed) ---
    - name: Configure CMake
      run: |
        mkdir build
        cmake -S . -B build

    # --- Build, Test, and Artifact Steps remain the same ---
    - name: Compile Project
      run: cmake --build build --config Release -- -j$(nproc)

    - name: Run Tests
      run: ctest --test-dir build --output-on-failure || true

    - name: Install Final Executable
      run: cmake --install build --prefix ./install_dir
    
    - name: Upload Executable Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ip-tracker-linux-executable
        path: install_dir
        if-no-files-found: error
        
