name: C/C++ CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-22.04 

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Install Dependencies & Compile GTest üõ†Ô∏è
      run: |
        # Update packages and install tools
        sudo apt-get update
        # Install build essentials, CMake, libcurl-dev, and libgtest-dev (source files)
        sudo apt-get install -y build-essential cmake libcurl4-openssl-dev libgtest-dev
        
        echo "Compiling and installing GTest libraries to system path..."
        
        # 1. Define a temporary build directory for GTest compilation
        GTEST_BUILD_DIR=/tmp/gtest_build
        sudo mkdir -p $GTEST_BUILD_DIR
        
        # 2. Compile GTest from the installed source
        cd $GTEST_BUILD_DIR
        sudo cmake /usr/src/googletest/
        sudo make
        
        # 3. Install the compiled GTest files to the standard library path
        # This is the crucial step to resolve CMake's FindGTest error.
        sudo cp lib/libgtest*.a /usr/lib/x86_64-linux-gnu/
        
        # 4. Return to the root of your project repository
        cd $GITHUB_WORKSPACE
        
    - name: Configure CMake
      run: |
        # Create out-of-source build directory
        mkdir build
        # Configure the project
        cmake -S . -B build

    - name: Compile Project
      # Compile using all available CPU cores for maximum speed
      run: cmake --build build --config Release -- -j$(nproc)

    - name: Run Tests
      # Execute tests using CTest
      run: ctest --test-dir build --output-on-failure || true

    - name: Install Final Executable
      # Install the compiled output into a temporary directory
      run: cmake --install build --prefix ./install_dir
    
    - name: Upload Executable Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ip-tracker-linux-executable
        path: install_dir
        if-no-files-found: error
        
